SRC_DIR = $(SRC_TREE)/condor_classad.V6

/* select required features */
#include "classad_features.h"


C_PLUS_FLAGS 		= -Wall $(STD_C_PLUS_FLAGS)
CFLAGS 				= -Wall $(STD_C_FLAGS) 


/* The basic classad source and object files */
CLASSAD_SRC_0 		= lexer.C source.C operators.C attrrefs.C fnCall.C   \
                      literals.C exprTree.C classad.C exprList.C value.C \
                      instantiations.C sink.C matchClassad.C util.C      \
                      xmlLexer.C xmlSink.C xmlSource.C cclassad.C
CLASSAD_OBJ_0 		= lexer.o source.o operators.o attrrefs.o fnCall.o   \
                      literals.o exprTree.o classad.o exprList.o value.o \
                      instantiations.o sink.o  matchClassad.o util.o     \
                      xmlLexer.o xmlSink.o xmlSource.o cclassad.o


/* Are collections required? */
#if defined(COLLECTIONS)
CLASSAD_SRC_1		= $(CLASSAD_SRC_0) view.C collection.C collectionBase.C   \
                      collectionServer.C collectionClient.C transaction.C     \
                      query.C remoteQuery.C coll-comm-inst.C coll-serv-inst.C \
                      coll-client-inst.C indexfile.C 
CLASSAD_OBJ_1		= $(CLASSAD_OBJ_0) view.o collection.o collectionBase.o   \
                      collectionServer.o collectionClient.o transaction.o     \
                      query.o remoteQuery.o	coll-comm-inst.o coll-serv-inst.o \
                      coll-client-inst.o indexfile.o
#else
CLASSAD_SRC_1		= $(CLASSAD_SRC_0)
CLASSAD_OBJ_1		= $(CLASSAD_OBJ_0)
#endif


/* Are experimental features required? */
#if defined(EXPERIMENTAL)
CLASSAD_SRC_2		= $(CLASSAD_SRC_1) rectangle.C intervalTree.C compress.C\
						queryProcessor.C exp-inst.C
CLASSAD_OBJ_2		= $(CLASSAD_OBJ_1) rectangle.o intervalTree.o compress.o\
						queryProcessor.o exp-inst.o
#else
CLASSAD_SRC_2		= $(CLASSAD_SRC_1)
CLASSAD_OBJ_2		= $(CLASSAD_OBJ_1)
#endif


SRC = $(CLASSAD_SRC_2)
OBJ = $(CLASSAD_OBJ_2)


LIB =  ./libclassad.a ../condor_c++_util/cplus_lib.a \
      ../condor_util_lib/util_lib.a ../condor_io/libcedar.a \
      ../condor_c++_util/cplus_lib.a ../condor_util_lib/util_lib.a \
	../condor_util_lib/util_lib.a ../condor_sysapi/libsysapi.a 


/* The S_* files are for standalone classads */
S_OBJ = $(S_UTL_OBJ) $(S_LCL_OBJ)
#if !HAS_FLOCK
S_UTL_OBJ = ../condor_util_lib/except.o ../condor_util_lib/dprintf.o \
			../condor_c++_util/uids.o ../condor_util_lib/escapes.o \
			../condor_util_lib/flock.o
#else
S_UTL_OBJ = ../condor_util_lib/except.o ../condor_util_lib/dprintf.o \
			../condor_c++_util/uids.o ../condor_util_lib/escapes.o 
#endif
S_LCL_OBJ = ./stand_alone.o


/* the main condor library target */
all_target(libclassad.a test_classads test_xml)
library_target(libclassad.a,$(OBJ))


/* template instantiations go in here */
template_inst( instantiations.C, instantiations.o ) 	/* main classad insts */
template_inst( coll-comm-inst.C, coll-comm-inst.o ) 	/* common collection  */
template_inst( coll-serv-inst.C, coll-serv-inst.o ) 	/* collection server  */
template_inst( coll-client-inst.C,coll-client-inst.o) 	/* collection client*/
template_inst( exp-inst.C, exp-inst.o )					/* experimental */

/* Standalone distribution of classads/collections */
DISTRIBUTION_DIR = classads_0.9.2

DIST_FILES = attrrefs.C attrrefs.h classad.C classad.h collection.C \
collection.h collectionBase.C collectionBase.h common.h classadErrno.h \
classadItor.h debug.C debug.h exprList.C exprList.h exprTree.C \
exprTree.h fnCall.C fnCall.h indexfile.h indexfile.C instantiations.C lexer.C \
lexer.h literals.C literals.h matchClassad.C matchClassad.h operators.C \
operators.h query.C query.h sample.C sink.C sink.h source.C source.h \
test_classads.C test_xml.C tests.txt transaction.C transaction.h value.C \
value.h view.C view.h xmlLexer.C xmlLexer.h xmlSink.h xmlSink.C xmlSource.h \
xmlSource.C classad_distribution.h cclassad.C cclassad.h LICENSE README \
CHANGELOG configure

dist: $(DIST_FILES)
	rm -rf $(DISTRIBUTION_DIR) *.gz
	mkdir $(DISTRIBUTION_DIR)
	cp $(DIST_FILES) $(DISTRIBUTION_DIR)
	cp makefile-dist $(DISTRIBUTION_DIR)/Makefile
	tar cf $(DISTRIBUTION_DIR).tar $(DISTRIBUTION_DIR)
	gzip $(DISTRIBUTION_DIR).tar

/* Rule to make documentation */
doc: html


/* Also depends on several header files, but I am ignoring that for now */
html_target( documentation )

clean::
	rm -f -r *.o *.gz html

/* The Classad eXpression Interpreter */
c_plus_target (cxi, cxi.o, $(LIB))
c_plus_target (test_classads, test_classads.o, $(LIB))
c_plus_target (test_xml, test_xml.o, $(LIB))
c_plus_target (man_cache_test, man_cache_test.o, $(LIB))
pure_c_plus_target (test_classads.pure, test_classads.o, $(LIB))
