#!/bin/sh

hold_arguments()
{
	cat >/tmp/configure.rerun <<EOF
#!/bin/sh
$0 $@
EOF
	chmod 755 /tmp/configure.rerun
	return
}

save_arguments()
{
    echo "saving args in configure.rerun"
    mv /tmp/configure.rerun .
	return
}

print_usage()
{
	cat <<EOF
Use: configure [options]
Where options are:
 --prefix  <dir>     The directory in which to install $project
 --enable-shlib      Allow user functions in shared libraries.
 --enable-namespace  Use the classad namespace
 --allow-covariants  Allow covariant return types
 --help              Show this message         
Use configure.rerun to rerun configure with previously saved arguments.
EOF
	return
}

hold_arguments "$@"

project="ClassAds"
install_dir="/usr/local"
enable_shlib=0
enable_namespace=0
allow_covariants=0

while [ $# -gt 0 ]
do
	case $1 in
		--prefix)
			shift
			install_dir=$1
			;;
		--enable-shlib)
			enable_shlib=1
			;;
		--enable-namespace)
			enable_namespace=1
			;;
        --allow-covariants)
			allow_covariants=1
			;;
		-h | -help | --h | --help)
			print_usage
			exit 1
			;;
		*)
			echo "Unknown argument $1"
			print_usage
			exit 1
			;;
	esac
	shift
done

save_arguments

echo "Creating Makefile.config..."

cat <<EOF >Makefile.config
# Generated at `date` by `whoami`@`uname -n`

DESTDIR = ${install_dir}
EOF

if [ ${enable_shlib} = 1 ]
then
echo "EXTRA_LD_FLAGS = -Xlinker --export-dynamic -ldl" >> Makefile.config
echo "all:: shared" >> Makefile.config
fi

if [ ${enable_namespace} = 1 ]
then
echo "EXTRA_C_PLUS_FLAGS = -DWANT_NAMESPACES" >> Makefile.config
fi

echo "Creating classad_features.h..."
rm -f classad_features.h
echo "/* classad_features.h, automatically generated at " `date` "*/" >> classad_features.h
cat >> classad_features.h <<EOF
#ifndef __CLASSAD_FEATURES_H
#define __CLASSAD_FEATURES_H

EOF
if [ ${enable_shlib} = 1 ] 
then
cat >> classad_features.h <<EOF
#define ENABLE_SHARED_LIBRARY_FUNCTIONS

EOF
fi

if [ ${allow_covariants} = 1 ]
then
cat >> classad_features.h <<EOF
#define USE_COVARIANT_RETURN_TYPES

EOF
fi

echo "#endif" >> classad_features.h


echo ""
echo "To build, type 'make'"
echo "To install, type 'make install'"
echo ""

exit 0

