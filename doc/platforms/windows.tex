%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{\label{sec:platform-windows}Microsoft Windows}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{platform-specific information!Windows|(}

Windows is a strategic platform for Condor,
and therefore we have been working toward a complete
port to Windows.
Our goal is to make Condor every bit as capable on Windows as it is on
Unix -- or even more capable.

Porting Condor from Unix to Windows is a formidable task,
because many
components of Condor must interact closely with the underlying operating
system.
Instead of waiting until all components of Condor are running
and stabilized on Windows,
we have decided to make a clipped version of Condor for Windows.
A clipped version is one in which there is no checkpointing
and there are no remote system calls.

This section contains additional information specific to running
Condor on Windows.  Eventually this information will be integrated
into the Condor Manual as a whole, and this section will disappear.
In order to effectively use Condor, first read the overview
chapter (section~\ref{sec:overview})
and the user's manual (section~\ref{sec:usermanual}).
If you will
also be administrating or customizing the policy and set up of Condor,
also read the administrator's manual 
chapter (section~\ref{sec:Admin-Intro}).
After reading these chapters,
review the information in this chapter for
important information and differences when using and administrating
Condor on Windows.
For information on installing Condor for Windows, see
section~\ref{sec:Windows-Install}.



\subsection{What is missing from Condor \VersionNotice\ for Windows?}
\index{Windows!release notes}

In general, this release for Windows works the same as the 
release of Condor for Unix.
However, the following items are not supported in this version:

\begin{itemize}

\item The Standard, Globus, and PVM job universes are not yet present.
This is no transparent process checkpoint/migration, and there are no
remote system calls.

\item Accessing files via a network share that requires a kerberos ticket
(such as AFS) is not yet supported.

\item The ability to run the job with the same credentials as the
submitting user is not yet supported.  Instead, Condor will use a set
of accounts (one per VM) with minimal access rights to run the job.

\end{itemize}

\subsection{What is included in Condor \VersionNotice\ for Windows?}

Except for those items listed above, most everything works
the same way in Condor as it does in the Unix release.
This release is based on the Condor \VersionNotice\ source tree, and thus the
feature set is the same as Condor \VersionNotice\ for Unix.  
For instance, all of the following work in Condor:
\begin{itemize}

\item The ability to submit, run, and manage queues of jobs running on a
cluster of Windows machines.

\item All tools such as \Condor{q}, \Condor{status}, \Condor{userprio},
are included. Only \Condor{compile} is
\emph{not} included.

\item The ability to customize job policy using ClassAds.
The machine ClassAds contain all the information included in the Unix version,
including current load average, RAM and virtual memory sizes, integer and
floating-point performance, keyboard/mouse idle time, etc.  Likewise, job
ClassAds contain a full complement of information, including system
dependent entries such as dynamic updates of the job's image size and CPU
usage.

\item Everything necessary to run a Condor central manager on Windows.

\item Security mechanisms.

\item Support for SMP machines.

\item Condor for Windows can run jobs at a lower operating system
priority level.
Jobs can be suspended, soft-killed by using a WM\_CLOSE message,
or hard-killed automatically based upon policy expressions.
For example, Condor can automatically suspend a job
whenever keyboard/mouse or non-Condor created CPU activity is detected, and
continue the job after the the machine has been idle for a specified amount
of time.

\item Condor correctly manages jobs which create multiple processes.  For
instance, if a Condor job spawns multiple processes and Condor
needs to kill the job,
all processes created by the job will be terminated.

\item In addition to interactive tools, users and administrators can receive
information from Condor by e-mail (standard SMTP) and/or by log files.

\item Condor includes a friendly GUI installation and set up program,
which can perform a full install or deinstall of Condor.
Information specified by the user in the set up program is stored in the
system registry.  
The set up program can update a current installation with a
new release using a minimal amount of effort.

\end{itemize}


\subsection{Details on how Condor for Windows starts/stops a job}

This section provides some details on how Condor starts and stops jobs.
This discussion is geared for the Condor administrator or advanced user who is
already familiar with the material in the Administrator's Manual
and wishes to know detailed information on what Condor does when
starting and stopping jobs.

When Condor is about to start a job, the \Condor{startd} on the execute
machine spawns a \Condor{starter} process.  The \Condor{starter} then
creates:
\begin{enumerate}

\item a run account on the machine with a login name of
``condor-reuse-vmX'', where X is the Virtual Machine number of the
\Condor{starter}.  This account is added to group Users.

\item a new temporary working directory for the job on the execute machine.
This directory is
named ``dir\_XXX'', where XXX is the process ID of the \Condor{starter}.
The directory is created in the \MacroUNI{EXECUTE} directory as
specified in Condor's configuration file.  Condor then grants write
permission to this directory for the user account newly created for the
job.

\item a new, non-visible Window Station and Desktop for the job.
Permissions are set so that only the
user account newly created has access rights to this Desktop.  Any windows
created by this job are not seen by anyone; the job is run in the
background.

\end{enumerate}

Next, the \Condor{starter} (called the starter) contacts the \Condor{shadow}
(called the shadow) process, which is
running on the submitting machine, and pulls over the job's executable and
input files.
These files are placed into the temporary working directory for the job.
After all files have been received,
the starter spawns the user's executable as user ``condor-reuse-vmX'', where X is the number of the virtual machine (or 1 on a uniprocessor machine).
Its current working directory set to the temporary working directory
(that is, \MacroUNI{EXECUTE}/dir\_XXX, where XXX is the process id of the \Condor{starter} daemon).

While the job is running, the starter closely monitors the CPU
usage and image size of all processes started by the job.
Every 20 minutes the starter sends this information,
along with the total size of all files contained in the job's
temporary working directory, to the shadow.
The shadow then
inserts this information into the job's ClassAd so that policy and
scheduling expressions can make use of this dynamic information.

If the job exits of its own accord (that is, the job completes),
the starter
first terminates any processes started by the job which could still be
around if the job did not clean up after itself.
The starter examines the job's temporary working directory for any
files which have been created or modified and sends these files back
to the shadow running on the submit machine.
The shadow
places these files into the \Opt{initialdir} specified in the
submit description file; if no \Opt{initialdir} was specified, the files go
into the directory where the user invoked \Condor{submit}.
Once all the output files are safely transferred back,
the job is removed from the queue.
If, however, the \Condor{startd} forcibly kills the job before all output files
could be transferred, the job is not removed from the queue but instead
switches back to the Idle state.  

If the \Condor{startd} decides to vacate a job prematurely,
the starter sends a WM\_CLOSE message to the job.
If the job spawned multiple child processes, the WM\_CLOSE message is only
sent to the parent process (that is, the one started by the starter).
The
WM\_CLOSE message is the preferred way to terminate a process on Windows,
since this method allows the job to cleanup and free any resources it may
have allocated.
When the job exits, the starter cleans up any processes left behind.
At this point, if \Opt{transfer\_files} is set to
\Arg{ONEXIT} (the default) in the job's submit description file,
the job switches from states, from Running to Idle,
and no files are transferred back.
If \Opt{transfer\_files} is set to \Arg{ALWAYS}, then any files
in the job's temporary working directory which were changed or modified are
first sent back to the submitting machine.
But this time, the shadow places these
so-called intermediate files into a subdirectory created in the
\MacroUNI{SPOOL} directory on the submitting machine
(\MacroUNI{SPOOL} is specified in Condor's configuration file).
The job is then switched back to the Idle state until Condor finds
a different machine on which to run.
When the job is started again,
Condor places into the job's temporary working directory the executable
and input files as before,
\emph{plus} any files stored in the submit machine's \MacroUNI{SPOOL} directory for that job.  

\Note A Windows console process can intercept a WM\_CLOSE message
via the Win32 SetConsoleCtrlHandler() function if it needs to do special
cleanup work at vacate time; a WM\_CLOSE message
generates a CTRL\_CLOSE\_EVENT.  See SetConsoleCtrlHandler() in the Win32
documentation for more info.

\Note The default handler in Windows for a WM\_CLOSE message is for the
process to exit.  Of course, the job could be coded to ignore it and not
exit, but eventually the \Condor{startd} will become impatient and hard-kill
the job (if that is the policy desired by the administrator).

Finally, after the job has left and any files transferred back,
the starter
deletes the temporary working directory, the temporary
account, the WindowStation and the Desktop before exiting itself.
If the starter should terminate abnormally, the \Condor{startd}
attempts the clean up.
If for some reason the \Condor{startd} should disappear as well
(that is, if the entire machine was power-cycled hard),
the \Condor{startd} will clean up when Condor is restarted.

\subsection{Security considerations in Condor for Windows}

% WRT the backslash character, extra spaces are added before it
% as viewed from the html generated.
%   Karen has tried
%         \File{C:$\backslash$WINNT}
%         \File{C:\Bs WINNT}
% and neither works.

On the execute machine, the user job is run using the access token of an
account dynamically created by Condor which has bare-bones access rights and
privileges.  For instance, if your machines are configured so that only
Administrators have write access to
%\File{C:\Bs WINNT},
\verb@C:\WINNT@,
then certainly no
Condor job run on that machine would be able to write anything there.
The only files the job should be able to access on the execute machine
are files accessible by the Users and Everyone groups, and files in the
job's temporary working directory.

On the submit machine, Condor impersonates the submitting user, therefore
the File Transfer mechanism has the same access rights as the submitting
user.  For example, say only Administrators can write to
%\File{C:\Bs WINNT}
\verb@C:\WINNT@
on the submit machine,
and a user gives the following to \Condor{submit} :
\begin{verbatim}
         executable = mytrojan.exe
         initialdir = c:\winnt
         output = explorer.exe
         queue
\end{verbatim}
Unless that user is in group Administrators, Condor will not permit
\File{explorer.exe} to be overwritten.  

If for some reason the submitting user's account disappears between the time
\Condor{submit} was run and when the job runs, Condor is not able to check
and see if the now-defunct submitting user has read/write access to a given
file.  In this case, Condor will ensure that group ``Everyone'' has read or
write access to any file the job subsequently tries to read or write.  This
is in consideration for some network setups, where the user account only
exists for as long as the user is logged in.

Condor also provides protection to the job queue.  It would be bad if the
integrity of the job queue is compromised, because a malicious user could
remove other user's jobs or even change what executable a user's job will
run.  To guard against this, in Condor's default configuration all connections to the \Condor{schedd} (the
process which manages the job queue on a given machine) are authenticated
using Windows' SSPI security layer.  The user is then authenticated
using the same challenge-response protocol that Windows uses to authenticate
users to Windows file servers.  Once authenticated, the only users
allowed to edit job entry in the queue are:
\begin{enumerate}
\item the user who originally submitted that job (i.e. Condor allows users
to remove or edit their own jobs)
\item users listed in the \File{condor\_config} file parameter
\MacroNI{QUEUE\_SUPER\_USERS}.  In the default configuration, only the
``SYSTEM'' (LocalSystem) account is listed here.  
\end{enumerate}
\Warn Do not remove ``SYSTEM'' from \MacroNI{QUEUE\_SUPER\_USERS}, or
Condor itself will not be able to access the job queue when needed.  If the
LocalSystem account on your machine is compromised, you have all sorts of
problems!

To protect the actual job queue files themselves, the Condor installation
program will automatically set permissions on the entire Condor release
directory so that only Administrators have write access.

Finally, Condor has all the IP/Host-based security mechanisms present
in the full-blown version of Condor.  See section~\ref{sec:Host-Security}
starting on page~\pageref{sec:Host-Security} for complete information
on how to allow/deny access to Condor based upon machine host name or
IP address.

\subsection{Interoperability between Condor for Unix and Condor for Windows}

Unix machines and Windows machines running Condor can happily
co-exist in the same Condor pool without any problems.
Jobs submitted on Windows can run on Windows or Unix,
and jobs submitted on Unix can run on Unix or Windows.
Without any specification
(using the \AdAttr{requirements} expression in the submit description file),
the default behavior will be to 
require the execute machine to be of the same architecture and operating
system as the submit machine.

There is absolutely no need to run more than one Condor central manager,
even if you have both Unix and Windows machines.  The Condor central manager
itself can run on either Unix or Windows; there is no advantage to choosing
one over the other.  Here at University of Wisconsin-Madison, for
instance, we have hundreds of Unix (Solaris, Linux, Irix, etc) and
Windows machines in our Computer Science Department Condor pool.
Our central manager is running on Windows.  All is happy.

\subsection{Some differences between Condor for Unix -vs- Condor for Windows}

\begin{itemize}

\item On Unix, we recommend the creation of a ``\textit{condor}'' account
when installing Condor.  On Windows, this is not necessary, as Condor is
designed to run as a system service as user LocalSystem.

\item On Unix, Condor finds the \File{condor\_config} main configuration
file by looking in \Tilde condor, in /etc, or via an environment variable.
On NT, the location of \File{condor\_config} file is determined
via the registry key \File{HKEY\_LOCAL\_MACHINE/Software/Condor}.
You can override this value by setting an environment variable named
\Env{CONDOR\_CONFIG}.

\item On Unix, in the VANILLA universe at job vacate time Condor sends the
job a softkill signal defined in the submit-description file (defaults to
SIGTERM).  On NT, Condor sends a WM\_CLOSE message to the job at vacate
time.

\item On Unix, if one of the Condor daemons has a fault, a core file
will be created in the \MacroUNI{Log} directory.  On Condor NT, a
``core'' file will also be created, but instead of a memory dump of the
process it will be a very short ASCII text file which describes what
fault occurred and where it happened.  This information can be used by
the Condor developers to fix the problem.

\end{itemize}

\input{platforms/windows-install.tex}
\index{platform-specific information!Windows|)}
