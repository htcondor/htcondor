%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{\label{sec:Configuring-SMP}
Configuring The Startd for SMP Machines}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\index{SMP machines!configuration|(}
This section describes how to configure the \Condor{startd} for SMP
(Symmetric Multi-Processor) machines.
Beginning with Condor version 6.1, machines with more than one CPU can
be configured to run more than one job at a time.
As always, owners of the resources have great flexibility in defining
the policy under which multiple jobs may run, suspend, vacate, etc.  

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:How-Resources-Represented}
How Shared Resources are Represented to Condor}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The way SMP machines are represented to the Condor system is that
the shared resources are broken up into individual \Term{virtual
machines} (each virtual machine is called a VM).
Each VM can be matched and claimed by users.
Each VM is represented by an individual ClassAd
(see the ClassAd reference, section~\ref{classad-reference}, for
details). 
In this way, each SMP machine will appear to the Condor system as
a collection of separate VMs.  
As an example, an SMP machine named
vulture.cs.wisc.edu would appear to Condor as the
multiple machines, named vm1@vulture.cs.wisc.edu,
vm2@vulture.cs.wisc.edu,
vm3@vulture.cs.wisc.edu, and so on.

The way that the \Condor{startd} breaks up the
shared system resources into the different virtual machines  
is configurable.
All shared system resources (like RAM, disk space, swap space, etc.)
can either be divided evenly among all the virtual machines, with each
CPU getting its own virtual machine, or you can define your own
\Term{virtual machine types}, so that resources can be unevenly
partitioned.
The following section gives details on how to configure Condor to
divide the resources on an SMP machine into separate virtual machines.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:SMP-Divide}
Dividing System Resources in SMP Machines}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

This section describes the settings that allow you to define your own
virtual machine types and to control how many virtual machines of each
type are reported to Condor.

There are two main ways to go about partitioning an SMP machine:

\begin{description}

\item[Define your own virtual machine types.]
  By defining your own types, you can specify what fraction of shared
  system resources (CPU, RAM, swap space and disk space) go to each
  virtual machine.
  Once you define your own types, you can control how many of each
  type are reported at any given time.

\item[Evenly divide all resources.]  
  If you do not define your own types, the \Condor{startd} will
  automatically	partition your machine into virtual machines for you.
  It will do so by placing a single CPU in each VM, and evenly dividing
  all shared resources among the VMs.
  With this default partitioning, you only specify how many
  VMs are reported at a time.
  By default, all VMs are reported to Condor.

\end{description}

Beginning with Condor version 6.1.6, the number of each type being
reported can be changed at run-time, by issuing a reconfiguration
command to
the \Condor{startd} daemon (sending a SIGHUP or using \Condor{reconfig}).
However, the definitions for the types themselves cannot be changed
with reconfiguration.
If you change any VM type definitions, you must use \Condor{restart}
\begin{verbatim}
condor_restart -startd
\end{verbatim}
for that change to take effect.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:VM-Type-Define}
Defining Virtual Machine Types}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

To define your own virtual machine types, add configuration file
parameters that list how much of each system resource you want in the
given VM type.  Do this by defining configuration
variables of the form
\Macro{VIRTUAL\_MACHINE\_TYPE\_<N>}.
The <N> represents an integer (for example, 
\MacroNI{VIRTUAL\_MACHINE\_TYPE\_1}), which specifies the virtual 
machine type defined.
This number is used to configure how many VMs of this type
are advertised.

A type describes what share of the total system resources a given
virtual machine has available to it.

The type can be defined by:
\begin{itemize}
  % \frac{1}{4} doesn't work
  %\item A simple fraction, such as \frac{1}{4}
  \item A simple fraction, such as 1/4
  \item A simple percentage, such as 25\Percent
  \item A comma-separated list of attributes, with a percentage,
	fraction, or value for each one.
\end{itemize}
A simple fraction or percentage causes an allocation
of the total system resources.
This includes the number of CPUs.
A comma-separated list allows a fine-tuning of
the amounts for specific attributes.

The attributes that specify the number of CPUs
and the total amount of RAM in
the SMP machine do not change.
For these attributes, specify either absolute values or
percentages of the total available amount.  
For example, in a machine with 128 Mbytes of RAM,
all the following definitions result in the same allocation amount.
\begin{verbatim}
mem=64
mem=1/2
mem=50%
\end{verbatim}

Other attributes are dynamic, such as disk space and swap space.
For these, specify a percentage or fraction of the total
value that is allocated to each VM, instead of specifying absolute values.
As the total values of these resources change on your machine, each
VM will take its fraction of the total and report that as its
available amount.

The four attribute names are case insensitive when defining VM types.
The first letter of the attribute name distinguishes between
the attributes.
The four attributes, with several examples of acceptable names for
each are
\begin{itemize}
  \item Cpus, C, c, cpu 
  \item ram, RAM, MEMORY, memory, Mem, R, r, M, m
  \item disk, Disk, D, d
  \item swap, SWAP, S, s, VirtualMemory, V, v
\end{itemize}

As an example, consider a
host of 4 CPUs and 256 megs of RAM.
Here are valid example VM type definitions. 
Types 1-3 are all equivalent to each other, as are types 4-6

\MacroNI{VIRTUAL\_MACHINE\_TYPE\_1} = cpus=2, ram=128, swap=25\%, disk=1/2

\MacroNI{VIRTUAL\_MACHINE\_TYPE\_2} = cpus=1/2, memory=128, virt=25\%, disk=50\%

\MacroNI{VIRTUAL\_MACHINE\_TYPE\_3} = c=1/2, m=50\%, v=1/4, disk=1/2

\MacroNI{VIRTUAL\_MACHINE\_TYPE\_4} = c=25\%, m=64, v=1/4, d=25\%

\MacroNI{VIRTUAL\_MACHINE\_TYPE\_5} = 25\%

\MacroNI{VIRTUAL\_MACHINE\_TYPE\_6} = 1/4


The number of virtual machines of each type is set with the
configuration variable
\Macro{NUM\_VIRTUAL\_MACHINES\_TYPE\_<N>},
where N is the type as given in the
\MacroNI{VIRTUAL\_MACHINE\_TYPE\_<N>}variable.

Note that it is possible to set the configuration variables such
that they specify an impossible configuration.
If this occurs, the \Condor{startd} daemon fails after writing
a message to its log attempting to indicate the configuration
requirements that it could not implement.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:Config-VM-Number}
Evenly Divided Resources}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

If you are not defining your own VM types, then all resources
are divided equally among the VMs.
The number of VMs within the SMP machine is the only attribute
that needs to be defined.
Its definition is accomplished by setting the configuration
variable \Macro{NUM\_VIRTUAL\_MACHINES} to the
integer number of machines desired.
If variable \MacroNI{NUM\_VIRTUAL\_MACHINES} is not defined,
it defaults to the number of CPUs within the SMP machine.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:Config-SMP-Policy}
Configuring Startd Policy for SMP Machines}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\index{configuration!SMP machines}
Section~\ref{sec:Configuring-Policy} details the Startd
Policy Configuration.
This section continues the discussion with respect to SMP machines.

Each virtual machine within an SMP machine is treated as an
independent machine,
each with its own view of its machine state.
There is a single set of policy expressions for the SMP machine
as a whole.
This policy may consider the VM state(s) in its expressions.
This makes some policies easy to set, but it makes
other policies difficult or impossible to set.

An easy policy to set
configures how many of the virtual machines
notice console or tty activity on the SMP as a whole.
VMs that are not configured to notice any activity will report
ConsoleIdle and KeyboardIdle times from when the
\Condor{startd} daemon was started,
(plus a configurable number of seconds).
With this, you can set up a multiple CPU machine with
the default policy
settings plus add that the keyboard and console noticed by only one
virtual machine.
Assuming a reasonable load average (see
section~\ref{sec:SMP-Load} below on ``Load Average for SMP
Machines''), only the one virtual machine will suspend or vacate its job
when the owner starts typing at their machine again.
The rest of the virtual machines could be matched with jobs and leave
them running, even while the user was interactively using the
machine. 
If the default policy is used,
all virtual machines notice
tty and console activity
and
currently running jobs would suspend or preempt.

This example policy is
controlled with the following configuration variables.
\begin{itemize}
\item \Macro{VIRTUAL\_MACHINES\_CONNECTED\_TO\_CONSOLE}
\item \Macro{VIRTUAL\_MACHINES\_CONNECTED\_TO\_KEYBOARD}
\item \Macro{DISCONNECTED\_KEYBOARD\_IDLE\_BOOST}
\end{itemize}

These configuration variables are fully described in
section~\ref{sec:Startd-Config-File-Entries} on
page~\pageref{sec:Startd-Config-File-Entries} which lists all the
configuration file settings for the \Condor{startd}.

% Karen's edit goes to this line.
% need discussion here about what canNOT be done given the single
% set  of policy expressions.
The configuration of virtual machines allows each VM to advertise
its own machine ClassAd.
Yet, there is only one set of policy expressions for the SMP
machine as a whole.
This makes the implementation of certain types of policies impossible.
While evaluating the state of one VM (within the SMP machine),
the state of other VMs (again within the SMP machine) are not
available.
Decisions for one VM cannot be based on what other machines within the SMP
are doing.

Specifically, the evaluation of a VM policy expression works in
the following way.
\begin{enumerate}
\item 
The configuration file specifies policy expressions that are shared among
all of the VMs on the SMP machine.
\item 
Each VM reads the configuration file and sets up its own machine ClassAd.
\item 
Each VM is now separate from the others.  It has a
different state, a different machine ClassAd, and if there is a job
running, a separate job ad.
Each VM periodically
evaluates the policy expressions, changing its own state
as necessary.
This occurs independently of the other VMs on the machine.
So, if the \Condor{startd} daemon is evaluating a policy expression
on a specific VM,
and the policy expression refers to \Attr{ProcID}, \Attr{Owner},
or any attribute from a job ad,
it \emph{always} refers to the ClassAd of the
job running on the specific VM.
\end{enumerate}

To set a different policy for the VMs within an SMP machine,
a (\verb@SUSPEND@) policy will be of the form
\begin{verbatim}
SUSPEND = ( (VirtualMachineID == 1) && (PolicyForVM1) ) || \
            ( (VirtualMachineID == 2) && (PolicyForVM2) )
\end{verbatim}
where \verb@(PolicyForVM1)@ and \verb@(PolicyForVM2)@ are the
desired expressions for each VM.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:SMP-Load}
Load Average for SMP Machines}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Most operating systems define the load average for an SMP machine as
the total load on all CPUs.
For example, if you have a 4-CPU machine with 3 CPU-bound processes
running at the same time, the load would be 3.0
In Condor, we maintain this view of the total load average and publish
it in all resource ClassAds as \Attr{TotalLoadAvg}.

Condor also provides a per-CPU load average for SMP machines.
This nicely represents the model that each node on an SMP is a virtual machine,
separate from the other nodes.
All of the default, single-CPU policy expressions can be used directly
on SMP machines, without modification, since the \Attr{LoadAvg} and
\Attr{CondorLoadAvg} attributes are the per-virtual machine versions,
not the total, SMP-wide versions.

The per-CPU load average on SMP machines is a Condor invention. 
No system call exists to ask the operating system for this value.
Condor already computes the load average generated by Condor on each
virtual machine.
It does this by close monitoring of all processes spawned by any of the
Condor daemons, even ones that are orphaned and then inherited by
\Prog{init}. 
This Condor load average per virtual machine is reported as
the attribute
\Attr{CondorLoadAvg} in all resource ClassAds, and the total Condor
load average for the entire machine is reported as
\Attr{TotalCondorLoadAvg}. 
The total, system-wide load average for the entire
machine  is reported as \Attr{TotalLoadAvg}.
Basically, Condor walks through all the virtual machines and assigns out
portions of the total load average to each one. 
First, Condor assigns the known Condor load average to each node that
is generating load.  
If there's any load average left in the total system load, it is
considered an owner load.
Any virtual machines Condor believes are in the Owner state (like
ones that have keyboard activity), are the first to get assigned
this owner load.
Condor hands out owner load in increments of at most 1.0, so generally
speaking, no virtual machine has a load average above 1.0.
If Condor runs out of total load average before it runs out of virtual
machines, all the remaining machines believe that they have no load average
at all.
If, instead, Condor runs out of virtual machines and it still has owner
load remaining, Condor starts assigning that load to Condor nodes as
well,
giving individual nodes with a load average higher than 1.0.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:SMP-logging}
Debug logging in the SMP Startd}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

This section describes how the \Condor{startd} daemon
handles its debugging messages for SMP machines.
In general, a given log message will either be something that is
machine-wide (like reporting the total system load average), or it
will be specific to a given virtual machine.
Any log entrees specific to a virtual machine have an extra
header printed out in the entry: \texttt{vm\#:}.  
So, for example, here's the output about system resources that are
being gathered (with \Dflag{FULLDEBUG} and \Dflag{LOAD} turned on) on
a 2-CPU machine with no Condor activity, and the keyboard connected to
both virtual machines:
\begin{verbatim}
11/25 18:15 Swap space: 131064
11/25 18:15 number of kbytes available for (/home/condor/execute): 1345063
11/25 18:15 Looking up RESERVED_DISK parameter
11/25 18:15 Reserving 5120 kbytes for file system
11/25 18:15 Disk space: 1339943
11/25 18:15 Load avg: 0.340000 0.800000 1.170000
11/25 18:15 Idle Time: user= 0 , console= 4 seconds
11/25 18:15 SystemLoad: 0.340   TotalCondorLoad: 0.000  TotalOwnerLoad: 0.340
11/25 18:15 vm1: Idle time: Keyboard: 0        Console: 4
11/25 18:15 vm1: SystemLoad: 0.340  CondorLoad: 0.000  OwnerLoad: 0.340
11/25 18:15 vm2: Idle time: Keyboard: 0        Console: 4
11/25 18:15 vm2: SystemLoad: 0.000  CondorLoad: 0.000  OwnerLoad: 0.000
11/25 18:15 vm1: State: Owner           Activity: Idle
11/25 18:15 vm2: State: Owner           Activity: Idle
\end{verbatim}

If, on the other hand, this machine only had one virtual machine
connected to the keyboard and console, and the other VM was running a
job, it might look something like this:
\begin{verbatim}
11/25 18:19 Load avg: 1.250000 0.910000 1.090000
11/25 18:19 Idle Time: user= 0 , console= 0 seconds
11/25 18:19 SystemLoad: 1.250   TotalCondorLoad: 0.996  TotalOwnerLoad: 0.254
11/25 18:19 vm1: Idle time: Keyboard: 0        Console: 0
11/25 18:19 vm1: SystemLoad: 0.254  CondorLoad: 0.000  OwnerLoad: 0.254
11/25 18:19 vm2: Idle time: Keyboard: 1496     Console: 1496
11/25 18:19 vm2: SystemLoad: 0.996  CondorLoad: 0.996  OwnerLoad: 0.000
11/25 18:19 vm1: State: Owner           Activity: Idle
11/25 18:19 vm2: State: Claimed         Activity: Busy
\end{verbatim}

As you can see, shared system resources are printed without the header
(like total swap space), and VM-specific messages (like the load
average or state of each VM) get the special header appended.  

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:SMP-exprs}
Configuring STARTD\_EXPRS on a per-VM basis}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The \Expr{STARTD\_EXPRS} and \Expr{STARTD\_ATTRS} settings can be
configured on a per-VM basis.
The \Condor{startd} daemon builds the list of items to
advertise by combining the the lists in this order:
\begin{enumerate}
\item{\Expr{STARTD\_EXPRS}}
\item{\Expr{VMx\_STARTD\_EXPRS}}
\item{\Expr{STARTD\_ATTRS}}
\item{\Expr{VMx\_STARTD\_ATTRS}} 
\end{enumerate}

In this example, the \Condor{startd} ClassAd for
VM1 will have values for 
\Attr{favorite\_color}, \Attr{favorite\_season},
and \Attr{favorite\_movie}.
VM2 will have values for 
\Attr{favorite\_color}, \Attr{favorite\_season}, and \Attr{favorite\_song}.

\begin{verbatim}
STARTD_EXPRS = favorite_color, favorite_season
VM1_STARTD_EXRS = favorite_movie
VM2_STARTD_EXPRS = favorite_song
\end{verbatim}

Attributes themselves in the \Expr{STARTD\_EXPRS}
and \Expr{STARTD\_ATTRS} list 
can also be on a per-VM basis.  
Here is another example:

\begin{verbatim}
favorite_color = "blue"
favorite_season = "spring"
STARTD_EXPRS = favorite_color, favorite_season
VM2_favorite_color = "green"
VM3_favorite_season = "summer"
\end{verbatim}

For this example, the \Condor{startd} ClassAds are
\begin{description}
\item{VM1}:
\begin{verbatim}
favorite_color = "blue"
favorite_season = "spring"
\end{verbatim}
\item{VM2}:
\begin{verbatim}
favorite_color = "green"
favorite_season = "spring"
\end{verbatim}
\item{VM3}:
\begin{verbatim}
favorite_color = "blue"
favorite_season = "summer"
\end{verbatim}
\end{description}

\index{SMP machines!configuration|)}
